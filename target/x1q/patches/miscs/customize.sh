SKIPUNZIP=1

# [
SET_PROP()
{
    local PROP="$1"
    local VALUE="$2"
    local FILE="$3"

    if [ ! -f "$FILE" ]; then
        echo "File not found: $FILE"
        return 1
    fi

    if [[ "$2" == "-d" ]] || [[ "$2" == "--delete" ]]; then
        PROP="$(echo -n "$PROP" | sed 's/=//g')"
        if grep -Fq "$PROP" "$FILE"; then
            echo "Deleting \"$PROP\" prop in $FILE" | sed "s.$WORK_DIR..g"
            sed -i "/^$PROP/d" "$FILE"
        fi
    else
        if grep -Fq "$PROP" "$FILE"; then
            local LINES

            echo "Replacing \"$PROP\" prop with \"$VALUE\" in $FILE" | sed "s.$WORK_DIR..g"
            LINES="$(sed -n "/^${PROP}\b/=" "$FILE")"
            for l in $LINES; do
                sed -i "$l c${PROP}=${VALUE}" "$FILE"
            done
        else
            echo "Adding \"$PROP\" prop with \"$VALUE\" in $FILE" | sed "s.$WORK_DIR..g"
            if ! grep -q "Added by scripts" "$FILE"; then
                echo "# Added by scripts/internal/apply_modules.sh" >> "$FILE"
            fi
            echo "$PROP=$VALUE" >> "$FILE"
        fi
    fi
}
# ]

echo "Fix up /product/etc/build.prop"
sed -i "/# Removed by /d" "$WORK_DIR/product/etc/build.prop" \
    && sed -i "s/#bluetooth./bluetooth./g" "$WORK_DIR/product/etc/build.prop" \
    && sed -i "s/?=/=/g" "$WORK_DIR/product/etc/build.prop" \
    && sed -i "$(sed -n "/provisioning.hostname/=" "$WORK_DIR/product/etc/build.prop" | sed "2p;d")d" "$WORK_DIR/product/etc/build.prop"

echo "Disable OEM unlock toggle"
SET_PROP "ro.oem_unlock_supported" "0" "$WORK_DIR/vendor/default.prop"

echo "Enable adaptive FPS"
sed -i \
    "/use_content_detection/i ro.surface_flinger.enable_frame_rate_override=false" \
    "$WORK_DIR/vendor/default.prop"
SET_PROP "ro.surface_flinger.use_content_detection_for_refresh_rate" "true" "$WORK_DIR/vendor/default.prop"
sed -i \
    "/use_content_detection/a ro.surface_flinger.set_idle_timer_ms=3000\nro.surface_flinger.set_touch_timer_ms=500\nro.surface_flinger.set_display_power_timer_ms=1000" \
    "$WORK_DIR/vendor/default.prop"

echo "Enable Fuse passthrough"
SET_PROP "persist.sys.fuse.passthrough.enable" "true" "$WORK_DIR/vendor/build.prop"

echo "Enable emulated storage"
SET_PROP "external_storage.projid.enabled" "1" "$WORK_DIR/vendor/build.prop"
SET_PROP "external_storage.casefold.enabled" "1" "$WORK_DIR/vendor/build.prop"
SET_PROP "external_storage.sdcardfs.enabled" "0" "$WORK_DIR/vendor/build.prop"
SET_PROP "ro.crypto.volume.options" "::v2" "$WORK_DIR/vendor/build.prop"
